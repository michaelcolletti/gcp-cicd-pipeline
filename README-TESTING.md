# Testing Guide

This document describes the testing infrastructure for the GCP CI/CD Pipeline project.

## Test Structure

### Node.js Application Tests
- **Location**: `HelloWorldNodeJs/index.test.js`
- **Framework**: Jest with Supertest
- **Coverage**: Configured with 80% threshold
- **Commands**:
  ```bash
  cd HelloWorldNodeJs
  npm test              # Run tests
  npm run test:watch    # Run tests in watch mode
  npm run test:coverage # Run with coverage report
  ```

### Shell Script Tests
- **Location**: `tests/pipeline.bats` and `tests/integration.bats`
- **Framework**: BATS (Bash Automated Testing System)
- **Coverage**: Unit tests for individual scripts and integration tests for pipeline flow
- **Commands**:
  ```bash
  bats tests/pipeline.bats     # Unit tests
  bats tests/integration.bats  # Integration tests
  ```

## Running All Tests

Use the provided test runner:
```bash
./test-runner.sh
```

This script will:
1. Install Node.js dependencies if needed
2. Run Jest tests with coverage
3. Run BATS tests if available
4. Provide summary of results

## Test Requirements

### For Node.js Tests
- Node.js and npm installed
- Dependencies: `jest`, `supertest` (automatically installed)

### For Shell Script Tests
- BATS framework installed:
  - **macOS**: `brew install bats-core`
  - **Ubuntu**: `sudo apt-get install bats`
  - **Manual**: https://github.com/bats-core/bats-core

## What Is Tested

### Node.js Application (`HelloWorldNodeJs/index.test.js`)
- ✅ HTTP GET requests return correct responses
- ✅ Default "World!" target handling
- ✅ Custom TARGET environment variable handling
- ✅ Console logging functionality
- ✅ 404 error handling for unknown routes

### Shell Scripts (`tests/pipeline.bats`)
- ✅ `enable-apis.sh` - API enablement commands
- ✅ `cloudbuild.sh` - Cloud Build YAML generation
- ✅ `clouddeploy.sh` - Cloud Deploy pipeline configuration
- ✅ `skaffold.sh` - Skaffold configuration generation
- ✅ `create-manifest.sh` - Kubernetes manifest creation
- ✅ `deploy.sh` - Deployment execution with proper parameters

### Integration Tests (`tests/integration.bats`)
- ✅ Complete pipeline flow generates all required files
- ✅ Generated YAML files are properly interconnected
- ✅ Environment variable substitution works correctly
- ✅ Error handling when dependencies are missing
- ✅ File dependencies and references are correct

## CI/CD Integration

The tests are integrated into the CI/CD pipeline:

### GitHub Actions
The workflow in `.github/workflows/build-autogenerated.yml` now properly runs:
- `npm install` - Install dependencies
- `npm run build` - Build verification  
- `npm test` - Run all tests

### Coverage Reports
Jest generates coverage reports in multiple formats:
- Console output during test runs
- HTML report in `HelloWorldNodeJs/coverage/`
- LCOV format for CI integration

## Test Development Guidelines

### Adding Node.js Tests
1. Follow Jest conventions
2. Use Supertest for HTTP testing
3. Mock external dependencies
4. Maintain 80% coverage threshold

### Adding Shell Script Tests
1. Use BATS framework conventions
2. Use `setup()` and `teardown()` functions for test isolation
3. Mock external commands (gcloud, etc.)
4. Test both success and error conditions
5. Use temporary directories for file generation tests

### Test Naming
- Use descriptive test names that explain what is being tested
- Group related tests using `describe` blocks (Jest) or similar patterns
- Include both positive and negative test cases